#!/bin/sh -x
# Copyright Â© 2009-2011 by Cycojesus

MAKE_DEPS=${MAKE_DEPS:-NO}

GEM=${GEM:-$1}

ARCH=${ARCH:-noarch}
BUILD=${BUILD:-1}
TAG=${TAG:-$(basename $0)}
OUTPUT=${OUTPUT:-/tmp}
TMP=${TMP:-/tmp/$TAG}
PKG=${PKG:-$TMP/pkg-rubygem-$GEM}
PREFIX=/usr

GEMSROOT=${GEMSROOT:-$(gem environment gemdir)}

if [ $MAKE_DEPS == YES ]; then
    TEMP_SCRIPT=$(mktemp)
    gem dependency --pipe --remote $* | sed "s|^\(.*\)$|$0 \1;|g" | sed "s|'|\\'|g" > $TEMP_SCRIPT
    /bin/sh $TEMP_SCRIPT
    rm $TEMP_SCRIPT
fi

rm -fr $PKG

mkdir -p $PKG$GEMSROOT

gem install $* \
    --install-dir $PKG$GEMSROOT \
    --bindir $PKG$PREFIX/bin \
    --force \
    --ignore-dependencies

cd $PKG

PRGNAM=rubygem-$(grep "s\.name = " $PKG$GEMSROOT/specifications/*.gemspec | grep -o "%q{.*}" | sed 's|%q{||' | tr -d '}')
VERSION=$(grep "s\.version = " $PKG$GEMSROOT/specifications/*.gemspec | grep -o "\".*\"" | tr -d '"')

mkdir -p $PKG/install
cat <<EOF > $PKG/install/slack-desc
$PRGNAM: $PRGNAM ($(grep "s\.summary = " $PKG$GEMSROOT/specifications/*.gemspec | grep -o "%q{.*}" | sed 's|%q{||' | tr -d '}'))
$PRGNAM:
$PRGNAM: $(grep "s\.description = " $PKG$GEMSROOT/specifications/*.gemspec | grep -o "%q{.*}" | sed 's|%q{||' | tr -d '}')
$PRGNAM:
$PRGNAM:
$PRGNAM:
$PRGNAM:
$PRGNAM:
$PRGNAM:
$PRGNAM: $(grep "s\.homepage = " $PKG$GEMSROOT/specifications/*.gemspec | grep -o "%q{.*}" | sed 's|%q{||' | tr -d '}')
$PRGNAM:
EOF

makepkg --linkadd y --chown n $OUTPUT/$PRGNAM-$VERSION-$ARCH-$BUILD$TAG.txz
